## 密码学

#### collision resistance（耐碰撞性）

无法人为的找出两个不同的输入但哈希输出是一样的情况。

利用该性质可以检验信息是否被篡改。

#### hiding

难以通过哈希值反推出输入是什么。前提是输入空间足够大，分布要均匀。

#### puzzle friendly

对于输出值，必须得算才知道，不能看到输入值就知道输出值。换句话说，就是挖矿的过程没有捷径，只能一个一个试。（difficult to solve , but easy to verify)

#### 比特币开户

本地创建一个公私钥对，则代表了比特币的账户。目前用的是非对称加密。 

使用接受者的公钥加密，当接受者收到后自己用私钥进行解密。

签名用的是私钥，验证签名用的是公钥。注意与加解密区分。即加密和签名是不一样的。

## 数据结构

#### 哈希指针（hash pointer）

哈希指针除了保存地址以外，还要保存该结构体的哈希值。这样可以检测结构体的内容是否被篡改。另外需要注意，哈希指针不能用在有环的情况。

#### 区块链（blockchain）

相较于普通链式结构，区块链是使用了哈希指针进行区块的链接，某个区块中的哈希指针保存的是前一个区块的哈希值。因而改变其中任意一个区块内容，则牵一发而动全身（被篡改的区块之后的哈希值全都需要重新计算）。

#### 默克尔树（merkle tree）

用哈希指针代替满二叉树的指针形成的树形结构。



## BTC-协议

数字货币需要解决双花问题（double spending attack），也需要考虑如何发行货币，因为去中心化的原因，没有中央银行了。

每一笔交易（转账）中，需要记录转账的那个人的币的来源信息，以便将币来源的输出脚本和此次交易的输入脚本拼在一起看能否运行。

#### 分布式共识（distributed consensus）

即网络中每个节点需要达成共识，让记录的账本只有一本。

分布式中的CAP理论（consistency, availability, partition tolerance），即一致性，可用性，分区可用性。https://stackoverflow.com/questions/12346326/cap-theorem-availability-and-partition-tolerance

C：整个集群中的数据是相同的，可以从任何节点读取或写入并获取相同的数据。

A：即使集群中的某个节点出现故障，也能够访问集群。

P：即使两个节点之间存在“partition”（通信中断）（两个节点均已启动，但无法通信），集群仍会继续运行。



## BTC-实现

比特币是transaction-based ledger，没有账户的概念。因而需要记录币的来源信息，但以太坊不需要，它是account-based ledger

全节点需要维护一个叫做UTXO（unspent transaction output）的数据结构。即还没有被花掉的交易的输出的集合。区块的输出是收款人的公钥哈希。维护该表能够快速检测双花问题，对交易的比特币进行溯源。

比特币平均每10分钟出一次块，但挖到矿的概率并不会随着你过去做的工作的累积而变大，也就是说，不管你在过去多努力的计算，你挖到矿的成功率是一样的（progress free）



## BTC-网络与挖矿难度

比特币节点维护一个交易池，收到一个合法交易后会转发给邻居节点，并标记（以后再收到就不转发了）

挖矿难度太低，容易出现很多分叉。因而会定期对挖矿难度进行调整，调整的代码是写在比特币协议里的。



## BTC-挖矿

####  全节点

- 一直在线
- 在本地硬盘维护完整的区块链信息
- 在内存里维护UTXO集合，以便快速检验交易的正确性
- 监听比特币网络的交易信息，验证每个交易的合法性
- 决定哪些交易被打包到区块里
- 监听挖出来的区块，验证其合法性
- 挖矿

#### 轻节点

- 不是一直在线
- 只保存每个区块的块头
- 只需保存与自己相关的交易，不用保存全部交易
- 只能验证和自己相关的交易的合法性
- 无法检测网上发布的区块的正确性
- 可以验证挖矿的难度
- 只能检测哪个是最长链，不知道哪个是最长合法链

比特币系统一大弊端，当掌握了系统的绝大多数算力后，容易出现很多问题：回滚账单，双花问题，boycott某个人的交易。



## 比特币脚本

比特币脚本是基于栈的语言。

![image-20231116222746787](C:\Users\24518\AppData\Roaming\Typora\typora-user-images\image-20231116222746787.png)

为了安全考虑，输入输出脚本在之后不会拼接到一起运行，而是分别运行。

主要是为了防止A冒充B，用A的公私钥将B的比特币转给别人。

P2PK（Pay to Public Key）

P2SH（Pay to Script Hash)

不懂



## BTC-分叉

#### state fork

- fork attack
- deliberate fork

#### protocol fork

- hard fork ：软件更新时，整个系统没有全部更新，未达成共识。比如每个块的大小变大等情况，造成各玩各的。
- soft fork：系统不会存在永久分叉的情况，如区块大小变小。

主要是看更新后，掌握少部分算力的能不能认可大部分算力挖的块，若认可则是软分叉，不认可则会硬分叉。（如少数服从多数，则是软分叉，不服从则是硬分叉）



## BTC-问答

#### 1.转账交易时，如果接收者不在线怎么办？

没关系 ，转账交易比特币本身只是记录这一条转账交易，对方是否在线没有关系。

#### 2.假设全节点收到了一个转账交易，有没有可能，转账交易中接收者的收款地址是该节点从未听说过的？

可能的。比特币账户的创建过程不需要通知其他人，只需要在本地产生一个公私钥对即可。只有第一次收到钱时，其他账户才知道该账户的存在。

#### 3.如果账户的私钥丢失了怎么办？

没有办法了，账户上的钱成了死钱，永远取不出来了。

#### 4.私钥泄露了怎么办？

尽快将账户上的钱转到另一个安全账户上。

#### 5.转账的时候写错了地址怎么办？

没有办法取消已经发布的交易。

#### 6. 矿工找到区块后发布，其他的矿工收到后会不会宣称区块是自己找到的？

不会。发布的区块里有一个coinbase，里面会有一个收款人地址（即挖到区块的矿工地址），如果要偷区块的话，需要将地址改成自己的，那么merkle root就会发生变化，导致那个随机值不符合要求。

#### 7.挖到矿时会有一定的交易费给到矿工，但挖到矿之前如何知道该交易费会给谁？

并不需要事先知道交易费会给到谁



## BTC-匿名性

比特币匿名性并没有多好，要想花出去总得和现实世界联系，这样一来总会留下蛛丝马迹。特别是用它干坏事，就算赚了很多比特币，也不敢花出去。

#### 假如自己是一个比特币用户，如何提高自己的匿名性？

比特币运行在应用层，要提高匿名性，需要在应用层和网络层同时改进。



## BTC-思考

####  “区块恋”

对于多个人共同拥有的账户，不能通过截断私钥平均分配给每个人的方法来保存私钥，这样会使安全性降低很多（已知其中一部分，需要暴力破解难度大幅降低）推荐使用多重签名。

#### 为什么比特币系统能够绕过分布式共识中的那些不可能结论？

严格意义上，比特币并没有取得完全的共识。

#### 量子计算？

不用过于担心，就算真有通用量子计算，首先冲击的也是传统金融行业，况且自己也没有比特币。。。另外，就算假设量子计算能够从公钥推导出私钥，但是比特币系统中是将公钥取了哈希，取哈希的过程会造成原有数据的丢失，即便是量子计算也不能逆向推导，若是能够推导，那么此哈希就是一个很厉害的压缩算法了。（加密解密和取哈希是不同的，量子计算能够轻易解密现有的加密算法）
